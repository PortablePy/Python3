from threading import Thread, Lock
from . import abstract_switch
from . import daqmx
from . import dcpower
from . import digital
from . import dmm
from . import fgen
from . import fpga
from . import scope
from . import switch

# from . import relay
# import pythoncom
from nitsm.codemoduleapi import SemiconductorModuleContext as SMContext


def initialize_all(
    tsm: SMContext,
):
    lock = Lock()
    """
    switch.initialize_sessions(tsm, lock)
    scope.initialize_sessions(tsm, lock)
    fpga.initialize_sessions(tsm, lock)
    fgen.initialize_sessions(tsm, lock)
    dmm.initialize_sessions(tsm, lock)
    digital.initialize_sessions(tsm, lock)
    dcpower.initialize_sessions(tsm, lock)
    daqmx.set_task(tsm, lock)
    """

    t_swt = Thread(name="Th_SWI", target=switch.initialize_sessions, args=(tsm, lock))
    t_osc = Thread(name="Th_OSC", target=scope.initialize_sessions, args=(tsm, lock))
    t_fpg = Thread(name="Th_FPG", target=fpga.initialize_sessions, args=(tsm, lock))
    t_fgn = Thread(name="Th_FGN", target=fgen.initialize_sessions, args=(tsm, lock))
    t_dmm = Thread(name="Th_DMM", target=dmm.initialize_sessions, args=(tsm, lock))
    t_dpi = Thread(name="Th_DPI", target=digital.initialize_sessions, args=(tsm, lock))
    t_smu = Thread(name="Th_SMU", target=dcpower.initialize_sessions, args=(tsm, lock))
    t_daq = Thread(name="Th_DAQ", target=daqmx.set_task, args=(tsm, lock))
    # start the threads
    t_swt.start()
    t_osc.start()
    t_fpg.start()
    t_fgn.start()
    t_dmm.start()
    t_dpi.start()
    t_smu.start()
    t_daq.start()
    # join threads
    t_swt.join()
    t_osc.join()
    t_fpg.join()
    t_fgn.join()
    t_dmm.join()
    t_dpi.join()
    t_smu.join()
    t_daq.join()
    # drivers ready init abstract switch

    abstract_switch.initialize(tsm)


def close_all(tsm: SMContext):
    abstract_switch.close_sessions(tsm)
    lock = Lock()
    """
    daqmx.clear_task(tsm)
    dcpower.close_sessions(tsm)
    digital.close_sessions(tsm)
    dmm.close_session(tsm)
    fgen.close_sessions(tsm)
    fpga.close_sessions(tsm)
    scope.initialize_sessions(tsm)
    switch.close_sessions(tsm)
    """
    t_daq = Thread(name="Th_DAQ", target=daqmx.clear_task, args=(tsm, lock))
    t_smu = Thread(name="Th_SMU", target=dcpower.close_sessions, args=(tsm, lock))
    t_dpi = Thread(name="Th_DPI", target=digital.close_sessions, args=(tsm, lock))
    t_dmm = Thread(name="Th_DMM", target=dmm.close_sessions, args=(tsm, lock))
    t_fgn = Thread(name="Th_FGN", target=fgen.close_sessions, args=(tsm, lock))
    t_fpg = Thread(name="Th_FPG", target=fpga.close_sessions, args=(tsm, lock))
    t_osc = Thread(name="Th_OSC", target=scope.close_sessions, args=(tsm, lock))
    t_swt = Thread(name="Th_SWI", target=switch.close_sessions, args=(tsm, lock))
    # start the threads
    t_daq.start()
    t_smu.start()
    t_dpi.start()
    t_dmm.start()
    t_fgn.start()
    t_fpg.start()
    t_osc.start()
    t_swt.start()
    # join threads
    t_daq.join()
    t_smu.join()
    t_dpi.join()
    t_dmm.join()
    t_fgn.join()
    t_fpg.join()
    t_osc.join()
    t_swt.join()
